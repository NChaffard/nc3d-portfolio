---
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageLayout from '../../layouts/PageLayout.astro';

export async function getStaticPaths() {
  const projets = await getCollection('projets');
  return projets.map((projet) => ({
    params: { slug: projet.id },
    props: { projet },
  }));
}

const { projet } = Astro.props as { projet: CollectionEntry<'projets'> };
const { Content } = await render(projet);
---

<BaseLayout pageTitle={projet.data.title} pageDescription={projet.data.description}>
  <PageLayout>
    <article class="projet-detail">
      <header class="projet-header">
        <h1>{projet.data.title}</h1>
        <p class="projet-meta">
          {projet.data.date.toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </p>
      </header>

      <section class="projet-gallery">
        <div class="gallery-grid">
          {projet.data.gallery.map((item: { image: string; alt: string }, index: number) => (
            <div class="gallery-item">
              {item.image.startsWith('http') ? (
                <img
                  src={item.image}
                  alt={item.alt}
                  class="gallery-image"
                  data-index={index}
                  width={800}
                  height={600}
                  loading="lazy"
                />
              ) : (
                <Image
                  src={item.image}
                  alt={item.alt}
                  class="gallery-image"
                  data-index={index}
                  width={800}
                  height={600}
                  quality={80}
                  loading="lazy"
                />
              )}
            </div>
          ))}
        </div>
      </section>

      <!-- Modal pour afficher les images en grand -->
      <div id="imageModal" class="modal">
        <span class="modal-close">&times;</span>
        <button class="modal-nav modal-prev" aria-label="Image précédente">&#10094;</button>
        <button class="modal-nav modal-next" aria-label="Image suivante">&#10095;</button>
        <img class="modal-content" id="modalImage" alt="" />
        <div class="modal-caption" id="modalCaption"></div>
      </div>

      <section class="projet-content">
        <Content />
      </section>

      <nav class="projet-nav">
        <a href="/" class="back-link">← Retour à l'accueil</a>
      </nav>
    </article>
  </PageLayout>
</BaseLayout>

<style>
  .projet-detail {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .projet-header {
    margin-top: 1rem;
    margin-bottom: 3rem;
    text-align: center;
  }

  .projet-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    color: #333;
  }

  .projet-meta {
    color: #666;
    font-size: 0.938rem;
    margin-bottom: 1rem;
    text-align: start;
  }

  .projet-description {
    font-size: 1.125rem;
    color: #555;
    line-height: 1.6;
  }

  .projet-gallery {
    margin-bottom: 3rem;
  }

  .projet-gallery h2 {
    font-size: 1.75rem;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    background: #f5f5f5;
  }

  .gallery-item {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.3s ease;
    cursor: pointer;
  }

  .gallery-item:hover {
    transform: scale(1.05);
  }

  /* Styles de la modale */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    overflow: hidden;
  }

  .modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    max-width: 90%;
    max-height: 90vh;
    object-fit: contain;
    animation: zoom 0.3s;
  }

  @keyframes zoom {
    from {
      transform: scale(0.7);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .modal-close {
    position: absolute;
    top: 20px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
    z-index: 1001;
  }

  .modal-close:hover,
  .modal-close:focus {
    color: #bbb;
  }

  .modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    font-size: 30px;
    padding: 16px 20px;
    cursor: pointer;
    transition: background-color 0.3s;
    z-index: 1001;
  }

  .modal-nav:hover {
    background-color: rgba(255, 255, 255, 0.4);
  }

  .modal-prev {
    left: 20px;
  }

  .modal-next {
    right: 20px;
  }

  .modal-caption {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: #f1f1f1;
    text-align: center;
    padding: 10px 20px;
    background-color: rgba(0, 0, 0, 0.5);
    border-radius: 4px;
    max-width: 80%;
  }

  .projet-content {
    margin-bottom: 3rem;
  }

  .projet-content h2 {
    font-size: 1.75rem;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .projet-content :global(p) {
    line-height: 1.7;
    margin-bottom: 1rem;
    color: #555;
  }

  .projet-content :global(h3) {
    font-size: 1.5rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #333;
  }

  .projet-content :global(ul),
  .projet-content :global(ol) {
    margin-bottom: 1rem;
    padding-left: 2rem;
  }

  .projet-content :global(li) {
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  .projet-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .projet-nav {
    padding-top: 2rem;
    border-top: 1px solid #e0e0e0;
  }

  .back-link {
    display: inline-block;
    color: #0066cc;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: #004499;
    text-decoration: underline;
  }

  @media (max-width: 768px) {
    .projet-header h1 {
      font-size: 2rem;
    }

    .gallery-grid {
      grid-template-columns: 1fr;
    }

    .modal-nav {
      font-size: 20px;
      padding: 12px 16px;
    }

    .modal-prev {
      left: 10px;
    }

    .modal-next {
      right: 10px;
    }

    .modal-close {
      top: 10px;
      right: 20px;
      font-size: 30px;
    }
  }
</style>

<script is:inline define:vars={{ gallery: projet.data.gallery }}>
  // Récupérer les éléments
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  const modalCaption = document.getElementById('modalCaption');
  const closeBtn = document.querySelector('.modal-close');
  const prevBtn = document.querySelector('.modal-prev');
  const nextBtn = document.querySelector('.modal-next');
  const galleryImages = document.querySelectorAll('.gallery-image');

  let currentIndex = 0;

  // Fonction pour afficher l'image dans la modale
  function showImage(index) {
    currentIndex = index;
    const item = gallery[index];
    // Utiliser l'image originale en haute qualité pour la modale
    modalImg.src = item.image;
    modalImg.alt = item.alt;
    modalCaption.textContent = item.alt;
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  // Fonction pour fermer la modale
  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  // Fonction pour naviguer vers l'image précédente
  function showPrevImage() {
    currentIndex = (currentIndex - 1 + gallery.length) % gallery.length;
    showImage(currentIndex);
  }

  // Fonction pour naviguer vers l'image suivante
  function showNextImage() {
    currentIndex = (currentIndex + 1) % gallery.length;
    showImage(currentIndex);
  }

  // Ajouter les événements de clic sur les images
  galleryImages.forEach((img, index) => {
    img.addEventListener('click', () => showImage(index));
  });

  // Fermer la modale
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Navigation
  prevBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    showPrevImage();
  });

  nextBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    showNextImage();
  });

  // Navigation au clavier
  document.addEventListener('keydown', (e) => {
    if (!modal.classList.contains('active')) return;

    switch(e.key) {
      case 'Escape':
        closeModal();
        break;
      case 'ArrowLeft':
        showPrevImage();
        break;
      case 'ArrowRight':
        showNextImage();
        break;
    }
  });
</script>
